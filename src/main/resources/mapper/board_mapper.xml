<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC   "-//mybatis.org//DTD Mapper 3.0//EN"
   "http://mybatis.org/dtd/mybatis-3-mapper.dtd"
>

<mapper namespace="kr.co.porkandspoon.dao.BoardDAO">
	
	<!-- 게시판 글 등록 -->
	<insert
		useGeneratedKeys="true"
	   	keyColumn="board_idx"
	   	keyProperty="board_idx"
	 	id="setBoardwrite"
	 	parameterType="kr.co.porkandspoon.dto.BoardDTO">
	    INSERT INTO free_board (
	        username,   
	        subject,  
	        content,
	        use_yn
	    )
	    VALUES (
	       	#{username},
	        #{subject}, 
	        #{content}, 
	        #{use_yn}
	    )
	</insert>
	
	
	<!-- 파일 저장하는 쿼리 -->
	<insert id="setBoardfiles" parameterType="kr.co.porkandspoon.dto.FileDTO">
	    INSERT INTO file (
	        code_name,
	        ori_filename,
	        new_filename,
	        type,
	        pk_idx
	    )
	    VALUES
	        (
	            #{code_name},
	            #{ori_filename},
	            #{new_filename},
	            #{type},
	            #{pk_idx}
	        )
	</insert>
	
	<!-- 게시판 리스트 및 검색 -->
	<select id="boardList" parameterType="map" resultType="kr.co.porkandspoon.dto.BoardDTO">
    	SELECT 
        f.board_idx,
        f.username,
        u.name AS userNick,
        f.subject,
        f.content,
        f.count,
        f.create_date,
        f.board_state,
        f.use_yn,
        f.board_notice,
        (SELECT CEIL(COUNT(*) / #{limit}) 
         FROM free_board f
         LEFT JOIN user u ON f.username = u.username
         LEFT JOIN department d ON u.parent = d.id
         WHERE 1 = 1
         <if test="keyword != null and keyword != ''">
             AND (
             <choose>
                 <when test="option == 'dept'">
                     d.text LIKE CONCAT('%', #{keyword}, '%')
                 </when>
                 <when test="option == 'name'">
                     f.username LIKE CONCAT('%', #{keyword}, '%')
                 </when>
                 <when test="option == 'subject'">
                     f.subject LIKE CONCAT('%', #{keyword}, '%')
                 </when>
             </choose>
             )
         </if>
        ) AS totalpage
    FROM 
        free_board f
        LEFT JOIN user u ON f.username = u.username
        LEFT JOIN department d ON u.parent = d.id
    WHERE 
        1 = 1
        <if test="keyword != null and keyword != ''">
            AND (
            <choose>
                <when test="option == 'dept'">
                    d.text LIKE CONCAT('%', #{keyword}, '%')
                </when>
                <when test="option == 'name'">
                    f.username LIKE CONCAT('%', #{keyword}, '%')
                </when>
                <when test="option == 'subject'">
                    f.subject LIKE CONCAT('%', #{keyword}, '%')
                </when>
            </choose>
            )
        </if>
    ORDER BY 
        f.board_idx DESC
    LIMIT #{offset}, #{limit}
</select>

</mapper>